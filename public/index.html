<!DOCTYPE html>
<html lang="zh-CN">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>GCash Deep Link Generator</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      padding: 20px;
    }

    .container {
      max-width: 800px;
      margin: 0 auto;
      background: white;
      border-radius: 20px;
      padding: 40px;
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
    }

    h1 {
      color: #333;
      margin-bottom: 10px;
      text-align: center;
    }

    .subtitle {
      text-align: center;
      color: #666;
      margin-bottom: 30px;
    }

    .form-group {
      margin-bottom: 20px;
    }

    label {
      display: block;
      color: #555;
      font-weight: 600;
      margin-bottom: 8px;
    }

    textarea,
    input,
    select {
      width: 100%;
      padding: 12px;
      border: 2px solid #e0e0e0;
      border-radius: 8px;
      font-size: 14px;
      transition: border-color 0.3s;
    }

    textarea {
      font-family: 'Courier New', monospace;
      min-height: 120px;
      resize: vertical;
    }

    textarea:focus,
    input:focus,
    select:focus {
      outline: none;
      border-color: #667eea;
    }

    .form-row {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 15px;
    }

    button {
      width: 100%;
      padding: 15px;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      border: none;
      border-radius: 8px;
      font-size: 16px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s;
    }

    button:hover {
      transform: translateY(-2px);
      box-shadow: 0 5px 20px rgba(102, 126, 234, 0.4);
    }

    button:disabled {
      background: #ccc;
      cursor: not-allowed;
      transform: none;
    }

    .result {
      margin-top: 30px;
      padding: 20px;
      background: #f8f9fa;
      border-radius: 12px;
      display: none;
    }

    .result.show {
      display: block;
      animation: slideUp 0.5s ease-out;
    }

    @keyframes slideUp {
      from {
        opacity: 0;
        transform: translateY(20px);
      }

      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    .result h3 {
      color: #667eea;
      margin-bottom: 15px;
    }

    .info-grid {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 10px;
      margin-bottom: 15px;
    }

    .info-item {
      padding: 10px;
      background: white;
      border-radius: 6px;
    }

    .info-label {
      font-size: 12px;
      color: #666;
      margin-bottom: 4px;
    }

    .info-value {
      font-weight: 600;
      color: #333;
    }

    .deeplink-box {
      margin-top: 15px;
      padding: 12px;
      background: white;
      border-radius: 8px;
      word-break: break-all;
      font-family: 'Courier New', monospace;
      font-size: 12px;
      max-height: 150px;
      overflow-y: auto;
    }

    .deeplink-edit {
      width: 100%;
      margin-top: 8px;
      padding: 12px;
      background: white;
      border: 2px solid #e0e0e0;
      border-radius: 8px;
      font-family: 'Courier New', monospace;
      font-size: 12px;
      resize: vertical;
      min-height: 80px;
      word-break: break-all;
      transition: border-color 0.3s;
    }

    .deeplink-edit:focus {
      outline: none;
      border-color: #667eea;
      background: #f8f9ff;
    }

    .actions {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 10px;
      margin-top: 15px;
    }

    .btn {
      padding: 12px;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      font-weight: 600;
      transition: all 0.3s;
    }

    .btn-primary {
      background: #28a745;
      color: white;
    }

    .btn-primary:hover {
      background: #218838;
      transform: translateY(-2px);
    }

    .btn-secondary {
      background: #6c757d;
      color: white;
    }

    .btn-secondary:hover {
      background: #5a6268;
      transform: translateY(-2px);
    }

    .error {
      margin-top: 20px;
      padding: 15px;
      background: #f8d7da;
      color: #721c24;
      border-radius: 8px;
      display: none;
    }

    .error.show {
      display: block;
    }

    .loading {
      text-align: center;
      padding: 20px;
      display: none;
    }

    .loading.show {
      display: block;
    }

    .spinner {
      border: 3px solid #f3f3f3;
      border-top: 3px solid #667eea;
      border-radius: 50%;
      width: 40px;
      height: 40px;
      animation: spin 1s linear infinite;
      margin: 0 auto;
    }

    @keyframes spin {
      0% {
        transform: rotate(0deg);
      }

      100% {
        transform: rotate(360deg);
      }
    }
  </style>
</head>

<body>
  <div class="container">
    <h1>ğŸš€ GCash Deep Link Generator</h1>
    <p class="subtitle">å°† EMVCo QR Code è½¬æ¢ä¸º GCash Deep Link</p>

    <div class="form-group">
      <label for="qrCode">EMVCo QR Code *</label>
      <textarea id="qrCode" placeholder="ç²˜è´´æ‚¨çš„ EMVCo QR Code æ•°æ®...&#10;ä¾‹å¦‚: 00020101021228530011ph.ppmi.p2m..."></textarea>
    </div>

    <div class="form-row">
      <div class="form-group">
        <label for="orderId">è®¢å• ID (å¯é€‰)</label>
        <input type="text" id="orderId" placeholder="ORDER-12345">
      </div>

      <div class="form-group">
        <label for="merchantId">å•†æˆ· ID (å¯é€‰)</label>
        <input type="text" id="merchantId" placeholder="217020000119199251998">
      </div>
    </div>

    <div class="form-group">
      <label for="paymentType">æ”¯ä»˜ç±»å‹</label>
      <select id="paymentType">
        <option value="">è‡ªåŠ¨åˆ¤æ–­</option>
        <option value="000">æ ‡å‡†æ”¯ä»˜ (000)</option>
        <option value="010">åŠ¨æ€ QR æ”¯ä»˜ (010)</option>
        <option value="001">é™æ€ QR æ”¯ä»˜ (001)</option>
      </select>
    </div>

    <div class="form-group">
      <label for="redirectUrl">å›è°ƒ URL (å¯é€‰)</label>
      <input type="text" id="redirectUrl" placeholder="https://yoursite.com/payment/success">
    </div>

    <div class="form-group">
      <label for="notifyUrl">é€šçŸ¥ URL (å¯é€‰)</label>
      <input type="text" id="notifyUrl" placeholder="https://yoursite.com/api/gcash/webhook">
    </div>

    <button id="generateBtn" onclick="generate()">ç”Ÿæˆ Deep Link</button>

    <div id="loading" class="loading">
      <div class="spinner"></div>
      <p style="margin-top: 10px; color: #666;">ç”Ÿæˆä¸­...</p>
    </div>

    <div id="error" class="error"></div>

    <div id="result" class="result">
      <h3>âœ… ç”ŸæˆæˆåŠŸ</h3>

      <div class="info-grid" id="infoGrid"></div>

      <div>
        <label style="margin-bottom: 8px; display: block;">ç”Ÿæˆçš„ Deep Link (å¯æ‰‹åŠ¨ç¼–è¾‘):</label>
        <textarea class="deeplink-edit" id="deepLinkEdit" rows="4" placeholder="Deep Link å°†æ˜¾ç¤ºåœ¨è¿™é‡Œï¼Œæ‚¨å¯ä»¥æ‰‹åŠ¨ç¼–è¾‘åå†æ‰“å¼€..."></textarea>
      </div>

      <div class="actions">
        <button class="btn btn-primary" onclick="openGCash()">
          ğŸš€ æ‰“å¼€ GCash
        </button>
        <button class="btn btn-secondary" onclick="copyLink()">
          ğŸ“‹ å¤åˆ¶é“¾æ¥
        </button>
      </div>
    </div>
  </div>

  <script>
    let currentDeepLink = '';
    async function generate() {
      const qrCode = document.getElementById('qrCode').value.trim();
      const orderId = document.getElementById('orderId').value.trim();
      const merchantId = document.getElementById('merchantId').value.trim();
      const redirectUrl = document.getElementById('redirectUrl').value.trim();
      const notifyUrl = document.getElementById('notifyUrl').value.trim();
      const paymentType = document.getElementById('paymentType').value;

      // éšè—ä¹‹å‰çš„ç»“æœ
      hideAll();

      // éªŒè¯è¾“å…¥
      if (!qrCode) {
        showError('è¯·è¾“å…¥ EMVCo QR Code');
        return;
      }

      // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
      showLoading();
      document.getElementById('generateBtn').disabled = true;

      try {
        const response = await fetch(`/api/generate`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({
            qrCode,
            orderId: orderId || undefined,
            merchantId: merchantId || undefined,
            redirectUrl: redirectUrl || undefined,
            notifyUrl: notifyUrl || undefined,
            paymentType: paymentType || undefined,
          })
        });

        if (!response.ok) {
          throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        }

        const data = await response.json();

        if (data.success) {
          currentDeepLink = data.deepLink;
          displayResult(data);
        } else {
          showError(data.error || 'ç”Ÿæˆå¤±è´¥');
        }
      } catch (error) {
        showError('ç½‘ç»œé”™è¯¯ï¼š' + error.message + '\n\nè¯·ç¡®ä¿åç«¯æœåŠ¡æ­£åœ¨è¿è¡Œ (http://localhost:9000)');
      } finally {
        hideLoading();
        document.getElementById('generateBtn').disabled = false;
      }
    }

    function displayResult(data) {
      const parsed = data.parsedData;

      // æ˜¾ç¤ºè§£æä¿¡æ¯
      const infoGrid = document.getElementById('infoGrid');
      infoGrid.innerHTML = `
                <div class="info-item">
                    <div class="info-label">å•†æˆ·åç§°</div>
                    <div class="info-value">${parsed.MerchantName || '-'}</div>
                </div>
                <div class="info-item">
                    <div class="info-label">é‡‘é¢</div>
                    <div class="info-value">â‚±${parsed.Amount || '0.00'}</div>
                </div>
                <div class="info-item">
                    <div class="info-label">åŸå¸‚</div>
                    <div class="info-value">${parsed.MerchantCity || '-'}</div>
                </div>
                <div class="info-item">
                    <div class="info-label">åº—é“º ID</div>
                    <div class="info-value">${parsed.ShopID || '-'}</div>
                </div>
            `;

      // æ˜¾ç¤º Deep Link åˆ°å¯ç¼–è¾‘çš„ textarea
      document.getElementById('deepLinkEdit').value = data.deepLink;

      // æ˜¾ç¤ºç»“æœåŒºåŸŸ
      document.getElementById('result').classList.add('show');
    }

    function openGCash() {
      // ä» textarea è·å–é“¾æ¥ï¼ˆæ”¯æŒæ‰‹åŠ¨ç¼–è¾‘ï¼‰
      const deepLink = document.getElementById('deepLinkEdit').value.trim();

      if (deepLink) {
        // å°è¯•æ‰“å¼€ GCash
        window.location.href = deepLink;

        // 2 ç§’åæ£€æŸ¥æ˜¯å¦æˆåŠŸæ‰“å¼€
        setTimeout(() => {
          if (!document.hidden) {
            alert('æ— æ³•æ‰“å¼€ GCash åº”ç”¨\n\nè¯·ç¡®ä¿:\n1. å·²å®‰è£… GCash åº”ç”¨\n2. åœ¨ç§»åŠ¨è®¾å¤‡ä¸Šæµ‹è¯•\n3. å…è®¸æµè§ˆå™¨æ‰“å¼€å¤–éƒ¨åº”ç”¨');
          }
        }, 2000);
      }
    }

    function copyLink() {
      // ä» textarea è·å–é“¾æ¥ï¼ˆæ”¯æŒæ‰‹åŠ¨ç¼–è¾‘ï¼‰
      const deepLink = document.getElementById('deepLinkEdit').value.trim();

      if (deepLink) {
        navigator.clipboard.writeText(deepLink).then(() => {
          alert('âœ… Deep Link å·²å¤åˆ¶åˆ°å‰ªè´´æ¿');
        }).catch(() => {
          // å¤‡ç”¨å¤åˆ¶æ–¹æ³•
          const textArea = document.createElement('textarea');
          textArea.value = deepLink;
          textArea.style.position = 'fixed';
          textArea.style.left = '-9999px';
          document.body.appendChild(textArea);
          textArea.select();
          try {
            document.execCommand('copy');
            alert('âœ… Deep Link å·²å¤åˆ¶åˆ°å‰ªè´´æ¿');
          } catch (err) {
            alert('âŒ å¤åˆ¶å¤±è´¥ï¼Œè¯·æ‰‹åŠ¨å¤åˆ¶');
          }
          document.body.removeChild(textArea);
        });
      } else {
        alert('âŒ æ²¡æœ‰å¯å¤åˆ¶çš„é“¾æ¥');
      }
    }

    function showLoading() {
      document.getElementById('loading').classList.add('show');
    }

    function hideLoading() {
      document.getElementById('loading').classList.remove('show');
    }

    function showError(message) {
      const errorDiv = document.getElementById('error');
      errorDiv.textContent = 'âŒ ' + message;
      errorDiv.classList.add('show');
    }

    function hideAll() {
      document.getElementById('result').classList.remove('show');
      document.getElementById('error').classList.remove('show');
      document.getElementById('loading').classList.remove('show');
    }

    // æ”¯æŒ Ctrl+Enter æäº¤
    document.getElementById('qrCode').addEventListener('keydown', (e) => {
      if (e.ctrlKey && e.key === 'Enter') {
        generate();
      }
    });

    // é¡µé¢åŠ è½½æ—¶æ£€æŸ¥åç«¯è¿æ¥
    window.addEventListener('load', async () => {
      try {
        const response = await fetch(`${API_BASE_URL}/health`);
        if (response.ok) {
          console.log('âœ… åç«¯æœåŠ¡è¿æ¥æˆåŠŸ');
        }
      } catch (error) {
        console.warn('âš ï¸ åç«¯æœåŠ¡æœªå¯åŠ¨ï¼Œè¯·è¿è¡Œï¼šgo run main.go');
      }
    });
  </script>
</body>

</html>